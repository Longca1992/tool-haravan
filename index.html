<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tool Up Gi√° (Vercel Core)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Roboto', sans-serif; padding: 20px; background: #e3f2fd; }
        .box { background: white; padding: 20px; border-radius: 8px; max-width: 600px; margin: 0 auto; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        h2 { text-align: center; color: #0277bd; margin-bottom: 20px; }
        input[type="password"], input[type="text"] { width: 100%; padding: 12px; margin-bottom: 10px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
        
        .upload-btn { background: #e1f5fe; border: 2px dashed #0288d1; color: #0277bd; padding: 15px; text-align: center; cursor: pointer; font-weight: bold; border-radius: 4px; margin-bottom: 15px; }
        .upload-btn:hover { background: #b3e5fc; }
        
        .btn-row { display: flex; gap: 10px; margin-top: 15px; }
        button { flex: 1; padding: 15px; border: none; border-radius: 4px; color: white; font-weight: bold; cursor: pointer; font-size: 14px; text-transform: uppercase; }
        .btn-si { background: linear-gradient(45deg, #ff6f00, #ff8f00); }
        .btn-le { background: linear-gradient(45deg, #2e7d32, #43a047); }
        button:disabled { background: #ccc; cursor: not-allowed; }

        .log { background: #263238; color: #eceff1; padding: 10px; height: 250px; overflow-y: auto; font-family: monospace; font-size: 12px; margin-top: 15px; border-radius: 4px; }
        .emp-list { display: flex; flex-wrap: wrap; gap: 10px; }
        .emp-item { background: #f5f5f5; padding: 8px 12px; border-radius: 20px; font-size: 13px; cursor: pointer; border: 1px solid #ddd; }
        .emp-item input { margin-right: 5px; }
    </style>
</head>
<body>

<div class="box">
    <h2>TOOL UP GI√Å (CORE VERCEL)</h2>
    
    <input type="password" id="token" placeholder="Nh·∫≠p Token Haravan...">
    <input type="text" id="note" placeholder="Ghi ch√∫ (VD: Gi√° √°p d·ª•ng 08/02)...">

    <div class="upload-btn" onclick="document.getElementById('upload').click()">
        üìÇ CH·ªåN FILE EXCEL
        <div id="file-name" style="font-weight:normal; font-size:12px; margin-top:5px;">(Ch∆∞a ch·ªçn file)</div>
        <input type="file" id="upload" accept=".xlsx" style="display:none">
    </div>

    <div class="emp-list">
        <label class="emp-item" style="background:#e0f2f1; font-weight:bold; color:#00695c;">
            <input type="checkbox" onchange="toggleAll(this)"> T·∫§T C·∫¢
        </label>
        <label class="emp-item"><input type="checkbox" class="emp-chk" value="nv1"> D∆∞∆°ng</label>
        <label class="emp-item"><input type="checkbox" class="emp-chk" value="nv3"> H·∫±ng</label>
        <label class="emp-item"><input type="checkbox" class="emp-chk" value="nv2"> Duy√™n</label>
        <label class="emp-item"><input type="checkbox" class="emp-chk" value="nv4"> Chi</label>
        <label class="emp-item"><input type="checkbox" class="emp-chk" value="general"> T·ªïng</label>
    </div>

    <div class="btn-row">
        <button class="btn-si" id="btn-si" onclick="run('wholesale')">‚ö° UP GI√Å S·ªà</button>
        <button class="btn-le" id="btn-le" onclick="run('retail')">üåê UP GI√Å L·∫∫</button>
    </div>
    
    <div class="log" id="console">S·∫µn s√†ng...</div>
</div>

<script>
    const IDS = {
        "nv1": { "wholesale": "1004290194", "retail": "1004292385", "name": "D∆∞∆°ng" },
        "nv3": { "wholesale": "1004290195", "retail": "1004292392", "name": "H·∫±ng" },
        "nv2": { "wholesale": "1004290197", "retail": "1004292393", "name": "Duy√™n" },
        "nv4": { "wholesale": "1004290198", "retail": "1004292394", "name": "Chi" },
        "general": { "wholesale": "1004285946", "retail": "1004292384", "name": "T·ªïng" }
    };
    
    // C·∫•u h√¨nh t·ª´ kh√≥a (Gi·ªØ nguy√™n logic c≈©)
    const SEARCH_KEYWORDS = ["M·ª±c 1 N·∫Øng", "M·ª±c Tr·ª©ng", "M·ª±c L√°", "M·ª±c ·ªêng", "M·ª±c Nang", "Kh√¥ M·ª±c", "RƒÉng M·ª±c", "M·ª±c", "T√¥m H√πm", "T√¥m B·∫Øc C·ª±c", "T√¥m T√≠t", "T√¥m Gi√≤n", "T√¥m", "C√° Th√°c L√°c", "·ª®c C√°", "C√° H·ªìi", "C√° Ng·ª´", "C√° Tr√≠ch", "C√° Tuy·∫øt", "C√° Sapa", "C√° Saba", "C√° Thu", "C√° ƒê√π", "C√° D·ª©a", "C√° Ninja", "C√° M√∫", "C√° S·∫∑c", "G√† ·ª¶ Mu·ªëi", "V√∫ Heo", "ƒê·∫≠u n√†nh", "Ch·∫£ Gi√≤", "ƒêi·ªáp 1 m·∫£nh", "Tobiko", "Ebiko", "V·∫πm", "B√≤", "B√†o Ng∆∞", "Vi C√°", "H·∫£i S√¢m", "B·∫°ch Tu·ªôc", "S√≤ ƒêi·ªáp", "C·ªìi ƒêi·ªáp", "S√≤ ƒê·ªè", "S√≤ L√¥ng", "S√≤ Huy·∫øt", "S√≤ Mai", "·ªêc H∆∞∆°ng", "·ªêc Bulot", "H√†u", "Th·ªãt Cua", "Th·ªãt Gh·∫π", "C√†ng Cua", "C√†ng Gh·∫π", "Cua Ho√†ng ƒê·∫ø", "Ch√¢n Cua Tuy·∫øt", "Ch·∫£ C√°", "Ch·∫£ M·ª±c", "Ch·∫£ Gh·∫π", "Ch·∫£ ·ªêc", "Ch·∫£ Ram", "Nem Chua", "Nem L·ª•i", "D·ªìi S·ª•n", "L∆∞∆°n Nh·∫≠t", "Unagi", "S·ª•n G√†", "C√°nh G√†", "ƒê√πi G√†", "Ch√¢n G√†", "Heo Iberico", "S∆∞·ªùn Heo", "Khoai T√¢y", "Ph√¥ Mai", "Rong Bi·ªÉn", "M√π T·∫°t", "N∆∞·ªõc T∆∞∆°ng", "G·ª´ng H·ªìng"];
    const CONFIG = { deleteKeywords: ["Set", "250gr", "240gr", "100gr", "200gr", "300gr", "50gr", "0,33gr", "2con", "2 t√∫i", "2 H·ªôp", "T√∫i 100gr", "10gr", "20gr", "1Con", "2 G√≥i"], keepNames: ["Nem", "Tobiko", "Ebiko", "Ph√¥ Mai Malaysia", "D·ªìi S·ª•n", "Rong"], garbageKeywords: ["X·ªëp", "Product-Haravan", "M√≥c Kho√°", "Ship", "S·∫£n Ph·∫©m Th√™m", "T√∫i H√∫t Ch√¢n Kh√¥ng", "Ph√≠ D·ªãch V·ª•", "T·∫£ng", "C∆∞·ªõc Xe", "ƒê·ªçc Ghi Ch√∫", "Ph√≠ DV"], sashimiKeywords: ["Sashimi", "Wasabi", "Rong"], meatKeywords: ["Heo", "B√≤", "G√†", "Ng·ªóng"], seafoodKeywords: ["T√¥m", "Cua", "Ghe", "Gh·∫π", "V·∫πm", "C·ªìi", "ƒêi·ªáp", "B√†o Ng∆∞", "Ngh√™u", "H√†u", "C√°", "M·ª±c", "S√≤", "L∆∞∆°n", "Rong", "H·∫£i", "B√†o"] };

    function log(msg, type) { 
        const c = document.getElementById('console'); 
        c.innerHTML += `<div style="color:${type==='err'?'#ff5252':(type==='ok'?'#69f0ae':'#fff')}">[${new Date().toLocaleTimeString()}] ${msg}</div>`; 
        c.scrollTop = c.scrollHeight; 
    }
    document.getElementById('upload').onchange = function() { if(this.files[0]) document.getElementById('file-name').innerText = this.files[0].name; }
    function toggleAll(e) { document.querySelectorAll('.emp-chk').forEach(c => c.checked = e.checked); }

    // --- LOGIC T·∫†O HTML S·∫†CH (CH·ªà TABLE) ---
    function generateCleanHTML(data, mode, note) {
        // Th·∫ª ·∫©n ch·ª©a ng√†y c·∫≠p nh·∫≠t ƒë·ªÉ Haravan ƒë·ªçc
        let html = `<span id="meta-date" style="display:none">${new Date().toLocaleString('vi-VN')} ${note ? '- ' + note : ''}</span>`;
        
        // Ph√¢n lo·∫°i d·ªØ li·ªáu
        let g = { sashimi:[], seafood:[], meat:[], other:[] };
        const k = Object.keys(data[0]);
        const find = (arr) => k.find(key => arr.some(x => key.toLowerCase().includes(x.toLowerCase())));
        const cN=find(["T√™n h√†ng","T√™n s·∫£n ph·∫©m"]), cR=find(["B·∫£ng gi√° chung","Gi√° l·∫ª"]), cC=find(["Gi√° CTV"]), c10=find(["S·ªâ t·ª´ 10kg"]), c50=find(["S·ªâ tr√™n 50kg"]);

        data.forEach(row => {
            let n = String(row[cN]||"").trim(), u = String(row["ƒê∆°n v·ªã t√≠nh"]||"").toLowerCase();
            if(!n) return;
            if(!CONFIG.keepNames.some(x=>n.toLowerCase().includes(x.toLowerCase()))) {
                if(u.includes("500gr") || CONFIG.deleteKeywords.some(x=>u.includes(x.toLowerCase())||n.toLowerCase().includes(x.toLowerCase())) || CONFIG.garbageKeywords.some(x=>JSON.stringify(row).toLowerCase().includes(x.toLowerCase()))) return;
            }
            let p10 = parseFloat(String(row[c10]).replace(/[^0-9]/g,''))||0;
            let p50 = parseFloat(String(row[c50]).replace(/[^0-9]/g,''))||0;
            let v10 = n.match(/-\s*[08]$/) ? p10 : Math.ceil((p10/1.05)/1000)*1000;
            let v50 = n.match(/-\s*[08]$/) ? p50 : Math.ceil((p50/1.05)/1000)*1000;
            
            const item = {
                name: n,
                link: generateSmartLink(n),
                retail: (parseFloat(String(row[cR]).replace(/[^0-9]/g,''))||0).toLocaleString('en-US'),
                ctv: (parseFloat(String(row[cC]).replace(/[^0-9]/g,''))||0).toLocaleString('en-US'),
                vat10: v10.toLocaleString('en-US'), hkd10: p10.toLocaleString('en-US'),
                vat50: v50.toLocaleString('en-US'), hkd50: p50.toLocaleString('en-US')
            };

            if(CONFIG.sashimiKeywords.some(x=>n.toLowerCase().includes(x.toLowerCase()))) g.sashimi.push(item);
            else if(CONFIG.seafoodKeywords.some(x=>n.toLowerCase().includes(x.toLowerCase()))) g.seafood.push(item);
            else if(CONFIG.meatKeywords.some(x=>n.toLowerCase().includes(x.toLowerCase()))) g.meat.push(item);
            else g.other.push(item);
        });

        // T·∫°o Table HTML
        const renderSection = (list, title, id) => {
            if(!list.length) return "";
            list.sort((a,b)=>a.name.localeCompare(b.name));
            
            let th = (mode === 'retail') 
                ? `<th>T√™n S·∫£n Ph·∫©m</th><th>Gi√° L·∫ª</th>`
                : `<th>T√™n S·∫£n Ph·∫©m</th><th>VAT 10Kg</th><th>HKD 10Kg</th><th>VAT 50Kg</th><th>HKD 50Kg</th><th>CTV</th><th>L·∫ª</th>`;
            
            let rows = list.map(i => {
                const link = `<br><a href="${i.link}" target="_blank" style="font-weight:normal;font-size:11px;color:#0068ff;text-decoration:none;">üëâ Xem Web</a>`;
                if(mode==='retail') return `<tr><td>${i.name}${link}</td><td class="price-retail">${i.retail}</td></tr>`;
                return `<tr><td>${i.name}${link}</td><td class="price-ws">${i.vat10}</td><td class="price-ws">${i.hkd10}</td><td class="price-ws">${i.vat50}</td><td class="price-ws">${i.hkd50}</td><td class="price-ws">${i.ctv}</td><td class="price-ws">${i.retail}</td></tr>`;
            }).join('');

            return `<div id="${id}" class="pricing-section"><div class="sec-title">${title}</div><table><thead><tr>${th}</tr></thead><tbody>${rows}</tbody></table></div>`;
        };

        html += renderSection(g.sashimi, "SASHIMI & SUSHI", "sashimi");
        html += renderSection(g.seafood, "H·∫¢I S·∫¢N", "haisan");
        html += renderSection(g.meat, "TH·ªäT NH·∫¨P KH·∫®U", "thit");
        html += renderSection(g.other, "KH√ÅC", "khac");
        return html;
    }

    function generateSmartLink(n) { 
        const u = n.toUpperCase(); 
        for(let k of SEARCH_KEYWORDS) if(u.includes(k.toUpperCase())) return `https://haisankyha.vn/search?type=product&q=${encodeURIComponent(k)}`; 
        return `https://haisankyha.vn/search?type=product&q=${encodeURIComponent(n.split(" ").slice(0,4).join(" "))}`; 
    }

    // --- H√ÄM CH·∫†Y ---
    async function run(mode) {
        const file = document.getElementById('upload').files[0];
        const token = document.getElementById('token').value.trim();
        const note = document.getElementById('note').value.trim();
        const checks = Array.from(document.querySelectorAll('.emp-chk:checked'));

        if(!file || !token || !checks.length) return alert('Thi·∫øu th√¥ng tin!');
        
        const btnId = mode === 'wholesale' ? 'btn-si' : 'btn-le';
        document.getElementById(btnId).disabled = true;
        
        log("=== B·∫ÆT ƒê·∫¶U X·ª¨ L√ù ===");
        
        const reader = new FileReader();
        reader.onload = async (e) => {
            const wb = XLSX.read(e.target.result, {type:'array'});
            const data = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]], {defval: ""});
            
            // T·∫°o HTML S·∫†CH (Ch·ªâ Table)
            const cleanHTML = generateCleanHTML(data, mode, note);
            
            // D√ôNG PROXY VERCEL ƒê·ªÇ TR√ÅNH L·ªñI FETCH
            const apiPrefix = '/haravan-api';

            for(let c of checks) {
                const info = IDS[c.value];
                const pageId = info[mode];
                log(`ƒêang x·ª≠ l√Ω: ${info.name}...`);

                try {
                    // 1. L·∫§Y TITLE C≈® (Qua Proxy)
                    const getRes = await fetch(`${apiPrefix}/web/pages/${pageId}.json`, {
                        headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' }
                    });
                    
                    let title = `B·∫£ng gi√° ${info.name}`;
                    if(getRes.ok) {
                        const d = await getRes.json();
                        title = d.page.title;
                    }

                    // 2. UPDATE (Qua Proxy - G·ª≠i HTML S·∫°ch)
                    const putRes = await fetch(`${apiPrefix}/web/pages/${pageId}.json`, {
                        method: 'PUT',
                        headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
                        body: JSON.stringify({ page: { id: pageId, title: title, body_html: cleanHTML } })
                    });

                    if(!putRes.ok) throw new Error(await putRes.text());
                    log(`‚úÖ ${info.name}: TH√ÄNH C√îNG!`, 'ok');
                    
                } catch(err) {
                    log(`‚ùå ${info.name}: L·ªói - ${err.message}`, 'err');
                }
            }
            alert("Ho√†n t·∫•t!");
            document.getElementById(btnId).disabled = false;
        };
        reader.readAsArrayBuffer(file);
    }
</script>
</body>
</html>
