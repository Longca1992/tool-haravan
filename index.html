<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tools AI Auto - LongCa (v85 Port to Vercel)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700;900&display=swap" rel="stylesheet">

    <style>
        /* GIAO DI·ªÜN GI·ªÆ NGUY√äN NH∆Ø C≈® - KH√îNG CH·ªàNH S·ª¨A */
        body { font-family: 'Roboto', sans-serif; padding: 30px 20px; text-align: center; background: linear-gradient(135deg, #e0f7fa 0%, #bbdefb 100%); min-height: 100vh; }
        .box { background: white; padding: 30px; border-radius: 20px; max-width: 650px; margin: 0 auto; box-shadow: 0 15px 35px rgba(0,0,0,0.15); border: 1px solid #fff; }
        h2 { color: #0277bd; margin: 0; text-transform: uppercase; font-weight: 900; font-size: 22px; letter-spacing: 1px; }
        h3.brand-title { margin: 5px 0 10px 0; font-size: 26px; font-weight: 900; background: -webkit-linear-gradient(45deg, #d84315, #ff6f00); -webkit-background-clip: text; -webkit-text-fill-color: transparent; text-transform: uppercase; }
        .copyright-header { font-size: 11px; color: #90a4ae; font-weight: 500; margin-bottom: 25px; letter-spacing: 0.5px; border-bottom: 1px dashed #eceff1; padding-bottom: 15px; }
        .copyright-header span { color: #0277bd; font-weight: bold; }
        .haravan-config { background: #fff8e1; padding: 15px; border-radius: 10px; border: 1px solid #ffe0b2; margin-bottom: 20px; text-align: left; }
        .haravan-config input { width: 100%; padding: 10px; margin-top: 5px; border: 1px solid #ffcc80; border-radius: 6px; box-sizing: border-box; font-size: 13px; }
        .upload-area { border: 2px dashed #4fc3f7; padding: 20px; background: #e1f5fe; border-radius: 12px; margin-bottom: 20px; cursor: pointer; transition: all 0.3s ease; }
        .upload-area:hover { background: #b3e5fc; border-color: #0288d1; }
        .upload-text { font-weight: bold; color: #0277bd; font-size: 16px; }
        .user-list { text-align: left; margin-bottom: 25px; }
        .user-list-title { font-weight: bold; color: #546e7a; margin-bottom: 10px; font-size: 13px; text-transform: uppercase; }
        .user-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .user-item { display: flex; align-items: center; padding: 10px; border-radius: 8px; background: #fafafa; border: 1px solid #eceff1; transition: 0.2s; cursor: pointer; }
        .user-item:hover { background: #e3f2fd; border-color: #90caf9; }
        .user-item.select-all-box { background: #e0f2f1; border-color: #80cbc4; }
        .user-item input { margin-right: 10px; transform: scale(1.3); cursor: pointer; accent-color: #0277bd; }
        .user-item label { cursor: pointer; color: #455a64; font-size: 14px; font-weight: 500; width: 100%;}
        .action-area { display: flex; flex-direction: column; gap: 15px; }
        .sync-group { display: flex; gap: 15px; }
        .download-group { display: flex; gap: 15px; border-top: 1px dashed #cfd8dc; padding-top: 15px; margin-top: 5px;}
        button { flex: 1; padding: 15px; border-radius: 8px; font-size: 14px; font-weight: bold; cursor: pointer; border: none; color: white; transition: all 0.2s; text-transform: uppercase; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        button:hover { transform: translateY(-2px); box-shadow: 0 6px 12px rgba(0,0,0,0.15); }
        button:active { transform: translateY(1px); }
        .btn-sync-si { background: linear-gradient(45deg, #ff6f00, #ff8f00); } 
        .btn-sync-le { background: linear-gradient(45deg, #2e7d32, #43a047); } 
        .btn-dl { background: linear-gradient(45deg, #546e7a, #78909c); font-size: 12px; padding: 12px;}
        button:disabled { background: #cfd8dc; transform: none; box-shadow: none; cursor: wait;}
        .note-small { font-size: 10px; color: rgba(255,255,255,0.9); margin-top: 2px; font-weight: normal; text-transform: none; }
        .update-note { font-size: 10px; color: #b0bec5; margin-top: 15px; font-style: italic; }
    </style>
</head>
<body>

    <div class="box">
        <h2>TOOLS AI X·ª¨ L√ù T·ª∞ ƒê·ªòNG 100%</h2>
        <h3 class="brand-title">B·∫¢NG GI√Å H·∫¢I S·∫¢N K·ª≤ H√Ä</h3>
        <div class="copyright-header">Tools AI X·ª≠ l√Ω B·∫£ng Gi√° By <span>LongCa</span></div>

        <div class="haravan-config">
            <div style="font-weight:bold; color:#e65100; font-size:12px;">üîë TOKEN API HARAVAN</div>
            <input type="password" id="haravan_token" placeholder="D√°n Token v√†o ƒë√¢y...">
        </div>
        
        <div class="upload-area" onclick="document.getElementById('upload').click()">
            <div class="upload-text">üìÇ CH·ªåN FILE EXCEL</div>
            <input type="file" id="upload" accept=".xlsx, .xls" style="display:none" />
            <div id="file-name" style="font-size:13px; color:#546e7a; margin-top: 5px;">(Ch∆∞a ch·ªçn file)</div>
        </div>

        <div class="user-list">
            <div class="user-list-title">üë§ CH·ªåN T√äN C·∫¶N X·ª¨ L√ù:</div>
            <div class="user-grid" id="employee-container">
                <div class="user-item select-all-box">
                    <input type="checkbox" id="check-all" onclick="toggleAll(this)">
                    <label for="check-all" style="color:#00695c; font-weight:bold;">‚úÖ CH·ªåN T·∫§T C·∫¢</label>
                </div>
            </div>
        </div>

        <div class="action-area">
            <div class="sync-group">
                <button class="btn-sync-si" id="btn-sync-si" onclick="processSync('wholesale')">
                    ‚ö° Up Gi√° S·ªâ
                    <div class="note-small">(T·ª± ƒë·ªông theo t√™n ƒë√£ ch·ªçn)</div>
                </button>
                <button class="btn-sync-le" id="btn-sync-le" onclick="processSync('retail')">
                    üåê Up Gi√° L·∫ª
                    <div class="note-small">(T·ª± ƒë·ªông theo t√™n ƒë√£ ch·ªçn)</div>
                </button>
            </div>
            <div class="download-group">
                <button class="btn-dl" onclick="processDownload('wholesale')">üíæ T·∫£i file S·ªà</button>
                <button class="btn-dl" onclick="processDownload('retail')">üíæ T·∫£i file L·∫∫</button>
            </div>
        </div>
        
        <div class="update-note">Running on Vercel Mode (Original v85 Logic)</div>
    </div>

<script>
    const HARAVAN_IDS = {
        "nv1": { "wholesale": "1004290194", "retail": "1004292385" },
        "nv3": { "wholesale": "1004290195", "retail": "1004292392" },
        "nv2": { "wholesale": "1004290197", "retail": "1004292393" },
        "nv4": { "wholesale": "1004290198", "retail": "1004292394" },
        "general": { "wholesale": "1004285946", "retail": "1004292384" }
    };
    
    const SEARCH_KEYWORDS = ["M·ª±c 1 N·∫Øng", "M·ª±c Tr·ª©ng", "M·ª±c L√°", "M·ª±c ·ªêng", "M·ª±c Nang", "Kh√¥ M·ª±c", "RƒÉng M·ª±c", "M·ª±c", "T√¥m H√πm", "T√¥m B·∫Øc C·ª±c", "T√¥m T√≠t", "T√¥m Gi√≤n", "T√¥m", "C√° Th√°c L√°c", "·ª®c C√°", "C√° H·ªìi", "C√° Ng·ª´", "C√° Tr√≠ch", "C√° Tuy·∫øt", "C√° Sapa", "C√° Saba", "C√° Thu", "C√° ƒê√π", "C√° D·ª©a", "C√° Ninja", "C√° M√∫", "C√° S·∫∑c", "G√† ·ª¶ Mu·ªëi", "V√∫ Heo", "ƒê·∫≠u n√†nh", "Ch·∫£ Gi√≤", "ƒêi·ªáp 1 m·∫£nh", "Tobiko", "Ebiko", "V·∫πm", "B√≤", "B√†o Ng∆∞", "Vi C√°", "H·∫£i S√¢m", "B·∫°ch Tu·ªôc", "S√≤ ƒêi·ªáp", "C·ªìi ƒêi·ªáp", "S√≤ ƒê·ªè", "S√≤ L√¥ng", "S√≤ Huy·∫øt", "S√≤ Mai", "·ªêc H∆∞∆°ng", "·ªêc Bulot", "H√†u", "Th·ªãt Cua", "Th·ªãt Gh·∫π", "C√†ng Cua", "C√†ng Gh·∫π", "Cua Ho√†ng ƒê·∫ø", "Ch√¢n Cua Tuy·∫øt", "Ch·∫£ C√°", "Ch·∫£ M·ª±c", "Ch·∫£ Gh·∫π", "Ch·∫£ ·ªêc", "Ch·∫£ Ram", "Nem Chua", "Nem L·ª•i", "D·ªìi S·ª•n", "L∆∞∆°n Nh·∫≠t", "Unagi", "S·ª•n G√†", "C√°nh G√†", "ƒê√πi G√†", "Ch√¢n G√†", "Heo Iberico", "S∆∞·ªùn Heo", "Khoai T√¢y", "Ph√¥ Mai", "Rong Bi·ªÉn", "M√π T·∫°t", "N∆∞·ªõc T∆∞∆°ng", "G·ª´ng H·ªìng"];
    SEARCH_KEYWORDS.sort((a, b) => b.length - a.length);

    const EMPLOYEES = [
        { id: "nv1", name: "Duong", phone: "0705777131", label: "D∆∞∆°ng" },
        { id: "nv3", name: "Hang",  phone: "0789698989", label: "H·∫±ng" },
        { id: "nv2", name: "Duyen", phone: "0937888155", label: "Duy√™n" },
        { id: "nv4", name: "Chi",   phone: "0936111846", label: "Chi" },
        { id: "general", name: "BangGiaTong", phone: "0987777131", label: "T·ªïng", type: "general" } 
    ];
    
    const ZALO_INFO = {
        "nv1": { zLabel: "D∆∞∆°ng", phone: "0705777131" },
        "nv2": { zLabel: "Duy√™n", phone: "0937888155" },
        "nv3": { zLabel: "H·∫±ng", phone: "0789698989" },
        "nv4": { zLabel: "Chi", phone: "0936111846" },
        "general": { zLabel: "T·ªïng", phone: "0987777131" }
    };
    
    const FOOTER_CONTACTS = [
        { name: "D∆∞∆°ng", phone: "0705777131" },
        { name: "H·∫±ng",  phone: "0789698989" },
        { name: "Duy√™n", phone: "0937888155" },
        { name: "Chi",   phone: "0936111846" }
    ];

    const CONFIG = {
        deleteKeywords: ["Set", "250gr", "240gr", "100gr", "200gr", "300gr", "50gr", "0,33gr", "2con", "2 t√∫i", "2 H·ªôp", "T√∫i 100gr", "10gr", "20gr", "1Con", "2 G√≥i"],
        keepNames: ["Nem", "Tobiko", "Ebiko", "Ph√¥ Mai Malaysia", "D·ªìi S·ª•n", "Rong"],
        garbageKeywords: ["X·ªëp", "Product-Haravan", "M√≥c Kho√°", "Ship", "S·∫£n Ph·∫©m Th√™m", "T√∫i H√∫t Ch√¢n Kh√¥ng", "Ph√≠ D·ªãch V·ª•", "T·∫£ng", "C∆∞·ªõc Xe", "ƒê·ªçc Ghi Ch√∫", "Ph√≠ DV"],
        sashimiKeywords: ["Sashimi", "Wasabi", "Rong"],
        meatKeywords: ["Heo", "B√≤", "G√†", "Ng·ªóng"],
        seafoodKeywords: ["T√¥m", "Cua", "Ghe", "Gh·∫π", "V·∫πm", "C·ªìi", "ƒêi·ªáp", "B√†o Ng∆∞", "Ngh√™u", "H√†u", "C√°", "M·ª±c", "S√≤", "L∆∞∆°n", "Rong", "H·∫£i", "B√†o"]
    };

    const container = document.getElementById('employee-container');
    EMPLOYEES.forEach(emp => {
        const div = document.createElement('div');
        div.className = 'user-item';
        div.innerHTML = `<input type="checkbox" class="emp-check" id="chk_${emp.id}" value="${emp.id}"><label for="chk_${emp.id}">${emp.label}</label>`;
        container.appendChild(div);
    });

    document.getElementById('upload').addEventListener('change', function(){
        const name = this.files[0] ? this.files[0].name : "";
        const label = document.getElementById('file-name');
        if(name) {
            label.innerText = "File: " + name;
            label.style.color = "#2e7d32";
            label.style.fontWeight = "bold";
        } else {
            label.innerText = "(Ch∆∞a ch·ªçn file)";
            label.style.color = "#546e7a";
        }
    });

    function toggleAll(source) {
        document.querySelectorAll('.emp-check').forEach(cb => cb.checked = source.checked);
    }

    function generateSmartLink(rawName) {
        const nameUpper = rawName.toUpperCase();
        for (let keyword of SEARCH_KEYWORDS) {
            if (nameUpper.includes(keyword.toUpperCase())) {
                return `https://haisankyha.vn/search?type=product&q=${encodeURIComponent(keyword)}`;
            }
        }
        let cleanName = rawName.replace(/\(.*?\)/g, "").replace(/-\s*\d+.*$/, "").trim();
        let words = cleanName.split(/\s+/);
        if (words.length > 4) cleanName = words.slice(0, 4).join(" ");
        return `https://haisankyha.vn/search?type=product&q=${encodeURIComponent(cleanName)}`;
    }

    function parse(v) { return parseFloat(String(v).replace(/[^0-9]/g,''))||0; }
    function fmt(v) { return (v<=0)?"Li√™n H·ªá":v.toLocaleString('en-US'); }

    function processData(jsonData) {
        const sRow = jsonData[0];
        const find = (keys) => { for(let k of keys) if(sRow[k]!==undefined) return k; return Object.keys(sRow).find(k=>keys.some(x=>k.toLowerCase().includes(x.toLowerCase()))); };
        const colName = find(["T√™n h√†ng", "T√™n s·∫£n ph·∫©m"]);
        const colRetail = find(["B·∫£ng gi√° chung", "Gi√° l·∫ª"]);
        const colCTV = find(["Gi√° CTV", "C·ªông t√°c vi√™n"]);
        const colBase10 = find(["S·ªâ t·ª´ 10kg", "Gi√° 10kg", "10kg"]);
        const colBase50 = find(["S·ªâ tr√™n 50kg", "Gi√° 50kg", "50kg"]);
        
        let processed = [];
        jsonData.forEach(row => {
            let name = String(row[colName]||"").trim(), unit = String(row["ƒê∆°n v·ªã t√≠nh"]||"").toLowerCase();
            if (!name) return;
            let isKeep = CONFIG.keepNames.some(n => name.toLowerCase().includes(n.toLowerCase()));
            if (!isKeep) {
                if (unit.includes("500gr")) return;
                if (CONFIG.deleteKeywords.some(k => unit.includes(k.toLowerCase()) || name.toLowerCase().includes(k.toLowerCase())) || CONFIG.garbageKeywords.some(k => JSON.stringify(row).toLowerCase().includes(k.toLowerCase()))) return;
            }
            let p10 = parse(row[colBase10]), p50 = parse(row[colBase50]);
            let v10 = name.match(/-\s*[08]$/) ? p10 : Math.ceil((p10/1.05)/1000)*1000;
            let v50 = name.match(/-\s*[08]$/) ? p50 : Math.ceil((p50/1.05)/1000)*1000;
            let link = generateSmartLink(name);
            processed.push({ name, link, retail: fmt(parse(row[colRetail])), ctv: fmt(parse(row[colCTV])), vat10: fmt(v10), hkd10: fmt(p10), vat50: fmt(v50), hkd50: fmt(p50) });
        });
        
        let groups = { sashimi: [], seafood: [], meat: [], other: [] };
        processed.forEach(i => {
            let n = i.name.toLowerCase();
            if (CONFIG.sashimiKeywords.some(k=>n.includes(k.toLowerCase()))) groups.sashimi.push(i);
            else if (CONFIG.seafoodKeywords.some(k=>n.includes(k.toLowerCase()))) groups.seafood.push(i);
            else if (CONFIG.meatKeywords.some(k=>n.includes(k.toLowerCase()))) groups.meat.push(i);
            else groups.other.push(i);
        });
        for(let k in groups) groups[k].sort((a,b)=>a.name.localeCompare(b.name));
        return groups;
    }

    function generateHTMLFinal(g, emp, mode) {
        const tableStyle = (mode === 'retail') ? "width:100%; border-collapse:collapse;" : "width:100%; border-collapse:collapse; min-width:800px;";
        const headerColor = (mode === 'retail') ? '#e65100' : '#0056b3';
        const thStyle = `background:${headerColor}; color:white; padding:8px; border:1px solid #ccc; text-align:center; white-space:nowrap;`;
        const tdStyle = "padding:8px; border:1px solid #ccc; text-align:center; color:#333; vertical-align: middle;";
        let nameTdStyle = (mode === 'retail') ? "padding:8px; border:1px solid #ccc; text-align:left; font-weight:bold; vertical-align: middle;" 
            : "padding:8px; border:1px solid #ccc; text-align:left; font-weight:bold; min-width:150px; position:sticky; left:0; background:white; z-index:10; border-right:2px solid #ddd; vertical-align: middle;";
        
        const note = `<div style="padding:10px; font-size:12px; color:#666; font-style:italic;">‚ö†Ô∏è Gi√° tham kh·∫£o (99%). Li√™n h·ªá Sales ƒë·ªÉ c·∫≠p nh·∫≠t gi√° chu·∫©n nh·∫•t.</div>`;
        
        let zaloButtonHTML = "";
        const zaloIconUrl = "https://upload.wikimedia.org/wikipedia/commons/thumb/9/91/Icon_of_Zalo.svg/1200px-Icon_of_Zalo.svg.png";
        const zaloColor = (mode === 'retail') ? '#e65100' : '#0068ff';
        const phoneColor = (mode === 'retail') ? '#e65100' : '#0068ff';

        if (emp.type === "general") {
            const items = FOOTER_CONTACTS.map((c, index) => {
                const borderStyle = index < FOOTER_CONTACTS.length - 1 ? "border-right: 1px solid #e0e0e0;" : "";
                return `<a href="https://zalo.me/${c.phone}" target="_blank" style="flex:1; display:flex; flex-direction:column; align-items:center; justify-content:center; text-decoration:none; color:#333; padding:8px 0; ${borderStyle}"><img src="${zaloIconUrl}" style="width:24px; height:24px; margin-bottom:4px;"><span style="font-size:11px; font-weight:bold; color:${phoneColor};">${c.name}</span></a>`;
            }).join('');
            zaloButtonHTML = `<div style="position:fixed !important; bottom:0 !important; left:0 !important; width:100% !important; height:60px; background:white; border-top:1px solid #ccc; box-shadow:0 -2px 10px rgba(0,0,0,0.1); z-index:2147483647 !important; display:flex; justify-content:space-around; align-items:center;">${items}</div>`;
        } else {
            const zInfo = ZALO_INFO[emp.id];
            zaloButtonHTML = `<a href="https://zalo.me/${zInfo.phone}" target="_blank" style="position:fixed !important; bottom:20px !important; right:20px !important; z-index:2147483647 !important; display:flex; align-items:center; background:${zaloColor}; color:white; padding:10px 20px; border-radius:30px; text-decoration:none; box-shadow:0 4px 10px rgba(0,0,0,0.3); font-weight:bold; font-family:sans-serif; border: 2px solid white;"><img src="${zaloIconUrl}" style="width:24px; height:24px; margin-right:8px; filter: brightness(0) invert(1);"> Chat Zalo: ${zInfo.zLabel}</a>`;
        }
        
        const swipeText = (mode === 'retail') ? '' : `<div style="font-size:12px; font-weight:bold; color:#d32f2f; font-style:italic; margin-bottom:5px; text-align:center;">‚¨ÖÔ∏è Vui l√≤ng vu·ªët sang tr√°i ƒë·ªÉ xem th√™m c√°c b·∫£ng gi√° kh√°c</div>`;
        let menuItems = [];
        if(g.sashimi.length) menuItems.push(`<a href="#sashimi" style="padding:6px 12px; background:#f1f3f4; border-radius:15px; color:#333; text-decoration:none; font-size:13px; white-space:nowrap; font-weight:bold;">üç£ Sashimi</a>`);
        if(g.seafood.length) menuItems.push(`<a href="#haisan" style="padding:6px 12px; background:#f1f3f4; border-radius:15px; color:#333; text-decoration:none; font-size:13px; white-space:nowrap; font-weight:bold;">ü¶Ä H·∫£i S·∫£n</a>`);
        if(g.meat.length) menuItems.push(`<a href="#thit" style="padding:6px 12px; background:#f1f3f4; border-radius:15px; color:#333; text-decoration:none; font-size:13px; white-space:nowrap; font-weight:bold;">ü•© Th·ªãt</a>`);
        if(g.other.length) menuItems.push(`<a href="#khac" style="padding:6px 12px; background:#f1f3f4; border-radius:15px; color:#333; text-decoration:none; font-size:13px; white-space:nowrap; font-weight:bold;">ü•¨ Kh√°c</a>`);
        
        const stickyHeader = `<div style="position:sticky; top:0; left:0; right:0; background:white; z-index:1000; border-bottom:1px solid #eee; padding:10px 10px 5px 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.05);">${swipeText}<div style="display:flex; gap:5px; overflow-x:auto; padding-bottom:5px;">${menuItems.join('')}</div></div>`;

        let h = "", r = null;
        if (mode === 'retail') {
            h = `<thead><tr><th style="${thStyle}">T√™n S·∫£n Ph·∫©m</th><th style="${thStyle} width:110px; min-width:110px;">Gi√° L·∫ª</th></tr></thead>`;
            r = (list) => list.map(i => {
                const linkHtml = i.link ? `<div style="margin-top:3px; font-weight:normal;"><a href="${i.link}" target="_blank" style="display:inline-block; padding:2px 0; color:#e65100; font-size:12px; font-style:italic; text-decoration:none;">üëâ Xem s·∫£n ph·∫©m</a></div>` : "";
                return `<tr><td style="${nameTdStyle}">${i.name}${linkHtml}</td><td style="${tdStyle} font-weight:bold; color:#d32f2f; white-space:nowrap;">${i.retail}</td></tr>`;
            }).join('');
        } else {
            h = `<thead><tr><th style="${thStyle}">T√™n S·∫£n Ph·∫©m</th><th style="${thStyle}">VAT C.Ty<br>10Kg</th><th style="${thStyle}">HKD<br>10Kg</th><th style="${thStyle}">VAT C.Ty<br>50Kg</th><th style="${thStyle}">HKD<br>50Kg</th><th style="${thStyle}">CTV</th><th style="${thStyle}">L·∫ª</th></tr></thead>`;
            r = (list) => list.map(i => {
                const linkHtml = i.link ? `<div style="margin-top:3px; font-weight:normal;"><a href="${i.link}" target="_blank" style="display:inline-block; padding:2px 0; color:#0068ff; font-size:12px; font-style:italic; text-decoration:none;">üëâ Xem s·∫£n ph·∫©m</a></div>` : "";
                return `<tr><td style="${nameTdStyle}">${i.name}${linkHtml}</td><td style="${tdStyle}">${i.vat10}</td><td style="${tdStyle}">${i.hkd10}</td><td style="${tdStyle}">${i.vat50}</td><td style="${tdStyle}">${i.hkd50}</td><td style="${tdStyle}">${i.ctv}</td><td style="${tdStyle}">${i.retail}</td></tr>`;
            }).join('');
        }
        const section = (id, title, data) => data.length ? `<div id="${id}" style="background:#f4f6f8; color:${headerColor}; padding:10px; font-weight:bold; margin:20px 0 5px 0; border-left:4px solid ${headerColor}; scroll-margin-top: 90px;">${title}</div><div style="width:100%; overflow-x:auto; -webkit-overflow-scrolling:touch;"><table style="${tableStyle}">${h}<tbody>${r(data)}</tbody></table></div>` : '';
        
        return `<div id="pricing-tool-wrapper" style="font-family:Arial, sans-serif; padding-bottom: 60px;">${note}${stickyHeader}${section('sashimi', 'SASHIMI & SUSHI', g.sashimi)}${section('haisan', 'H·∫¢I S·∫¢N', g.seafood)}${section('thit', 'TH·ªäT', g.meat)}${section('khac', 'KH√ÅC', g.other)}${zaloButtonHTML}</div>`;
    }

    async function processDownload(mode) { handleProcess('download', mode); }
    async function processSync(mode) {
        const selected = document.querySelectorAll('.emp-check:checked');
        if(selected.length === 0) { alert('‚ö†Ô∏è Vui l√≤ng ch·ªçn √≠t nh·∫•t 1 ng∆∞·ªùi!'); return; }
        if(confirm(`‚ö†Ô∏è B·∫†N S·∫ÆP C·∫¨P NH·∫¨T CHO ${selected.length} NG∆Ø·ªúI?\n\nCh·∫ø ƒë·ªô: ${mode === 'wholesale' ? 'GI√Å S·ªà' : 'GI√Å L·∫∫'}.\nD·ªØ li·ªáu tr√™n Web s·∫Ω b·ªã ghi ƒë√®.`)) {
            handleProcess('sync', mode);
        }
    }

    const delay = ms => new Promise(res => setTimeout(res, ms));

    async function handleProcess(actionType, mode) {
        const fileInput = document.getElementById('upload');
        const selectedChecks = Array.from(document.querySelectorAll('.emp-check:checked'));

        if (!fileInput.files.length) { alert('‚ö†Ô∏è Vui l√≤ng ch·ªçn file Excel!'); return; }
        if (selectedChecks.length === 0) { alert('‚ö†Ô∏è Vui l√≤ng ch·ªçn nh√¢n vi√™n!'); return; }

        let btnId = "";
        if(actionType === 'sync') btnId = mode === 'wholesale' ? 'btn-sync-si' : 'btn-sync-le';
        if(btnId) {
            var btn = document.getElementById(btnId);
            var originalText = btn.innerHTML;
            btn.innerHTML = "‚è≥ ƒêANG KH·ªûI ƒê·ªòNG...";
            btn.disabled = true;
        }

        const reader = new FileReader();
        reader.onload = async function(e) {
            try {
                const workbook = XLSX.read(e.target.result, {type: 'array'});
                const jsonData = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]], {defval: ""});
                const processedGroups = processData(jsonData);

                if (actionType === 'download') {
                    if(selectedChecks.length === 1) {
                         const empId = selectedChecks[0].value;
                         const emp = EMPLOYEES.find(e => e.id === empId);
                         const content = generateHTMLFinal(processedGroups, emp, mode);
                         const fullHtml = `<!DOCTYPE html><html lang="vi"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>B·∫£ng Gi√°</title></head><body>${content}</body></html>`;
                         const fileName = `Bang_Gia_${mode === 'wholesale' ? 'SI' : 'LE'}_${emp.name}.html`;
                         saveAs(new Blob([fullHtml], {type: "text/html;charset=utf-8"}), fileName);
                    } else {
                         const zip = new JSZip();
                         selectedChecks.forEach(chk => {
                             const empId = chk.value;
                             const emp = EMPLOYEES.find(e => e.id === empId);
                             const content = generateHTMLFinal(processedGroups, emp, mode);
                             const fullHtml = `<!DOCTYPE html><html lang="vi"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>B·∫£ng Gi√°</title></head><body>${content}</body></html>`;
                             zip.file(`Bang_Gia_${mode === 'wholesale' ? 'SI' : 'LE'}_${emp.name}.html`, fullHtml);
                         });
                         saveAs(await zip.generateAsync({type:"blob"}), `Bang_Gia_${mode === 'wholesale' ? 'SI' : 'LE'}_All.zip`);
                    }
                } else {
                    const token = document.getElementById('haravan_token').value.trim();
                    if (!token) throw new Error("Vui l√≤ng nh·∫≠p Token API!");
                    
                    // --- ƒê√ÇY L√Ä ƒêI·ªÇM S·ª¨A QUAN TR·ªåNG ƒê·ªÇ CH·∫†Y TR√äN VERCEL ---
                    // Nh·∫≠n di·ªán Vercel HO·∫∂C Netlify ƒë·ªÉ d√πng Proxy
                    const isProxyEnv = window.location.hostname.includes('netlify.app') || window.location.hostname.includes('vercel.app');
                    const apiPrefix = isProxyEnv ? '/haravan-api' : 'https://apis.haravan.com';

                    let successCount = 0;
                    let failLog = [];
                    
                    for(const [index, chk] of selectedChecks.entries()) {
                        const empId = chk.value;
                        const emp = EMPLOYEES.find(e => e.id === empId);
                        const pageId = HARAVAN_IDS[empId][mode];
                        const htmlContent = generateHTMLFinal(processedGroups, emp, mode);
                        
                        if(btnId) document.getElementById(btnId).innerHTML = `‚è≥ ƒêang up: ${emp.label} (${index+1}/${selectedChecks.length})...`;

                        if(index > 0) {
                             if(btnId) document.getElementById(btnId).innerHTML = `‚è≥ Server ƒëang ngh·ªâ m·ªát (2s)...`;
                             await delay(2000); 
                        }

                        try {
                            const url = `${apiPrefix}/web/pages/${pageId}.json`;
                            const response = await fetch(url, {
                                method: 'PUT',
                                headers: { 
                                    'Content-Type': 'application/json',
                                    'Authorization': `Bearer ${token}`,
                                    'Accept': 'application/json'
                                },
                                body: JSON.stringify({ page: { id: pageId, body_html: htmlContent } })
                            });

                            if (!response.ok) {
                                const errText = await response.text();
                                throw new Error(`${response.status} - ${errText.slice(0, 100)}...`);
                            }
                            successCount++;
                        } catch(err) {
                            failLog.push(`${emp.label} (L·ªói: ${err.message})`);
                        }
                    }

                    if(failLog.length === 0) {
                        alert(`‚úÖ TUY·ªÜT V·ªúI! ƒê√£ c·∫≠p nh·∫≠t xong c·∫£ ${successCount} b·∫£ng gi√°.`);
                    } else {
                        alert(`‚ö†Ô∏è ƒê√£ xong ${successCount} m·ª•c.\n‚ùå L·ªói ${failLog.length} m·ª•c:\n${failLog.join('\n')}`);
                    }
                }
            } catch (err) {
                alert("‚ùå L·ªói x·ª≠ l√Ω file: " + err.message);
            } finally {
                if(btnId) {
                    const btn = document.getElementById(btnId);
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                }
            }
        };
        reader.readAsArrayBuffer(fileInput.files[0]);
    }
</script>
</body>
</html>
