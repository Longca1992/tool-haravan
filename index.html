<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tools AI Auto - LongCa (v133 - Full v99 on Vercel)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700;900&display=swap" rel="stylesheet">

    <style>
        /* GIAO DI·ªÜN TOOL ADMIN */
        body { font-family: 'Roboto', sans-serif; padding: 20px; background: #f0f2f5; height: 100vh; box-sizing: border-box; overflow-y: auto; }
        .main-container { display: grid; grid-template-columns: 350px 1fr; gap: 20px; max-width: 1200px; margin: 0 auto; height: calc(100vh - 40px); }
        .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); border: 1px solid #e1e4e8; display: flex; flex-direction: column; }
        h2 { color: #0277bd; margin: 0 0 5px 0; font-weight: 900; font-size: 18px; text-transform: uppercase; }
        .form-group { margin-bottom: 15px; }
        .form-label { font-size: 12px; font-weight: bold; color: #455a64; display: block; margin-bottom: 5px; }
        input[type="text"], input[type="password"] { width: 100%; padding: 10px; border: 1px solid #cfd8dc; border-radius: 6px; font-size: 13px; box-sizing: border-box; }
        .upload-compact { display: flex; align-items: center; justify-content: space-between; background: #e1f5fe; border: 1px dashed #0288d1; padding: 10px 15px; border-radius: 8px; cursor: pointer; margin-bottom: 15px; transition: 0.2s; }
        .upload-compact:hover { background: #b3e5fc; }
        .user-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 8px; margin-bottom: 15px; }
        .user-item { display: flex; align-items: center; padding: 8px; border-radius: 6px; background: #fafafa; border: 1px solid #eceff1; cursor: pointer; transition: 0.2s; }
        .user-item:hover { background: #e3f2fd; border-color: #90caf9; }
        .user-item input { margin-right: 8px; transform: scale(1.2); cursor: pointer; }
        .user-item label { cursor: pointer; font-size: 13px; font-weight: 500; width: 100%; }
        .select-all { background: #e0f2f1; border-color: #80cbc4; }
        .action-row { display: flex; gap: 10px; margin-top: auto; }
        button { flex: 1; padding: 12px; border-radius: 6px; font-size: 13px; font-weight: bold; cursor: pointer; border: none; color: white; text-transform: uppercase; transition: 0.2s; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        button:disabled { background: #cfd8dc !important; cursor: not-allowed; }
        .btn-si { background: linear-gradient(45deg, #ff6f00, #ff8f00); } 
        .btn-le { background: linear-gradient(45deg, #2e7d32, #43a047); } 
        .btn-dl { background: #607d8b; width: 40px; flex: none; display: flex; align-items: center; justify-content: center; font-size: 16px; }
        .progress-container { width: 100%; background: #e0e0e0; height: 6px; border-radius: 3px; margin: 10px 0; overflow: hidden; }
        .progress-bar { width: 0%; height: 100%; background: #4caf50; transition: width 0.3s; }
        .log-console { background: #263238; color: #eceff1; font-family: monospace; font-size: 11px; padding: 10px; border-radius: 8px; flex: 1; overflow-y: auto; margin-top: 10px; white-space: pre-wrap; border: 1px solid #455a64; min-height: 100px; }
        .checkbox-row { display: flex; align-items: center; gap: 5px; margin-top: 5px; font-size: 12px; color: #37474f; cursor: pointer; }
        ::-webkit-scrollbar { width: 6px; } ::-webkit-scrollbar-track { background: #f1f1f1; } ::-webkit-scrollbar-thumb { background: #cfd8dc; border-radius: 3px; } ::-webkit-scrollbar-thumb:hover { background: #90a4ae; }
    </style>
</head>
<body>

<div class="main-container">
    <div class="card">
        <h2>TOOLS AI AUTO</h2>
        <div class="form-group">
            <label class="form-label">üîë HARAVAN TOKEN:</label>
            <input type="password" id="haravan_token" placeholder="D√°n Token API v√†o ƒë√¢y...">
        </div>
        <div style="border-top: 1px dashed #eee; margin: 10px 0;"></div>
        <div class="form-group">
            <label class="form-label" style="color:#d32f2f;">üìù N·ªòI DUNG GHI CH√ö:</label>
            <input type="text" id="update_note" placeholder="VD: H√†ng m·ªõi v·ªÅ, Gi√° gi·∫£m s·ªëc..." style="border-color:#ef9a9a; color:#c62828; font-weight:bold;">
        </div>
        <div class="form-group">
            <label class="form-label">üé® T√ôY CH·ªàNH:</label>
            <label class="checkbox-row">
                <input type="checkbox" id="hide_sticky_menu"> üö´ T·∫Øt Ch·∫ø ƒê·ªô D√≠nh (Sticky)
            </label>
        </div>
        <div style="margin-top:auto; font-size: 10px; color: #b0bec5; text-align: center;">Dev by LongCa</div>
    </div>

    <div class="card">
        <div class="upload-compact" onclick="document.getElementById('upload').click()">
            <div style="display:flex; align-items:center; gap:10px;">
                <span style="font-size:18px">üìÇ</span>
                <span style="font-weight:bold; color:#0277bd;">CH·ªåN FILE EXCEL</span>
            </div>
            <div id="file-name" class="file-status">(Ch∆∞a ch·ªçn file)</div>
            <input type="file" id="upload" accept=".xlsx, .xls" style="display:none" />
        </div>

        <div class="user-grid" id="employee-container">
            <div class="user-item select-all">
                <input type="checkbox" id="check-all" onclick="toggleAll(this)">
                <label for="check-all" style="font-weight:bold; color:#00695c;">CH·ªåN T·∫§T C·∫¢</label>
            </div>
        </div>

        <div class="progress-container"><div class="progress-bar" id="progress-bar"></div></div>
        <div class="log-console" id="log-console">S·∫µn s√†ng...</div>

        <div class="action-row" style="margin-top: 15px;">
            <button class="btn-si" id="btn-sync-si" onclick="processSync('wholesale')">‚ö° UP GI√Å S·ªà</button>
            <button class="btn-le" id="btn-sync-le" onclick="processSync('retail')">üåê UP GI√Å L·∫∫</button>
            <button class="btn-dl" onclick="processDownload('wholesale')" title="T·∫£i file S·ªà">üíæ S</button>
            <button class="btn-dl" onclick="processDownload('retail')" title="T·∫£i file L·∫∫">üíæ L</button>
        </div>
    </div>
</div>

<script>
    const HARAVAN_IDS = {
        "nv1": { "wholesale": "1004290194", "retail": "1004292385" },
        "nv3": { "wholesale": "1004290195", "retail": "1004292392" },
        "nv2": { "wholesale": "1004290197", "retail": "1004292393" },
        "nv4": { "wholesale": "1004290198", "retail": "1004292394" },
        "general": { "wholesale": "1004285946", "retail": "1004292384" }
    };
    
    const EMPLOYEES = [
        { id: "nv1", label: "D∆∞∆°ng" }, { id: "nv3", label: "H·∫±ng" }, { id: "nv2", label: "Duy√™n" },
        { id: "nv4", label: "Chi" }, { id: "general", label: "T·ªïng" }
    ];
    
    const ZALO_INFO = { "nv1": { zLabel: "D∆∞∆°ng", phone: "0705777131" }, "nv2": { zLabel: "Duy√™n", phone: "0937888155" }, "nv3": { zLabel: "H·∫±ng", phone: "0789698989" }, "nv4": { zLabel: "Chi", phone: "0936111846" }, "general": { zLabel: "T·ªïng", phone: "0987777131" } };
    const FOOTER_CONTACTS = [ { name: "D∆∞∆°ng", phone: "0705777131" }, { name: "H·∫±ng",  phone: "0789698989" }, { name: "Duy√™n", phone: "0937888155" }, { name: "Chi",   phone: "0936111846" } ];

    const SEARCH_KEYWORDS = ["M·ª±c 1 N·∫Øng", "M·ª±c Tr·ª©ng", "M·ª±c L√°", "M·ª±c ·ªêng", "M·ª±c Nang", "Kh√¥ M·ª±c", "RƒÉng M·ª±c", "M·ª±c", "T√¥m H√πm", "T√¥m B·∫Øc C·ª±c", "T√¥m T√≠t", "T√¥m Gi√≤n", "T√¥m", "C√° Th√°c L√°c", "·ª®c C√°", "C√° H·ªìi", "C√° Ng·ª´", "C√° Tr√≠ch", "C√° Tuy·∫øt", "C√° Sapa", "C√° Saba", "C√° Thu", "C√° ƒê√π", "C√° D·ª©a", "C√° Ninja", "C√° M√∫", "C√° S·∫∑c", "G√† ·ª¶ Mu·ªëi", "V√∫ Heo", "ƒê·∫≠u n√†nh", "Ch·∫£ Gi√≤", "ƒêi·ªáp 1 m·∫£nh", "Tobiko", "Ebiko", "V·∫πm", "B√≤", "B√†o Ng∆∞", "Vi C√°", "H·∫£i S√¢m", "B·∫°ch Tu·ªôc", "S√≤ ƒêi·ªáp", "C·ªìi ƒêi·ªáp", "S√≤ ƒê·ªè", "S√≤ L√¥ng", "S√≤ Huy·∫øt", "S√≤ Mai", "·ªêc H∆∞∆°ng", "·ªêc Bulot", "H√†u", "Th·ªãt Cua", "Th·ªãt Gh·∫π", "C√†ng Cua", "C√†ng Gh·∫π", "Cua Ho√†ng ƒê·∫ø", "Ch√¢n Cua Tuy·∫øt", "Ch·∫£ C√°", "Ch·∫£ M·ª±c", "Ch·∫£ Gh·∫π", "Ch·∫£ ·ªêc", "Ch·∫£ Ram", "Nem Chua", "Nem L·ª•i", "D·ªìi S·ª•n", "L∆∞∆°n Nh·∫≠t", "Unagi", "S·ª•n G√†", "C√°nh G√†", "ƒê√πi G√†", "Ch√¢n G√†", "Heo Iberico", "S∆∞·ªùn Heo", "Khoai T√¢y", "Ph√¥ Mai", "Rong Bi·ªÉn", "M√π T·∫°t", "N∆∞·ªõc T∆∞∆°ng", "G·ª´ng H·ªìng"];
    const CONFIG = { deleteKeywords: ["Set", "250gr", "240gr", "100gr", "200gr", "300gr", "50gr", "0,33gr", "2con", "2 t√∫i", "2 H·ªôp", "T√∫i 100gr", "10gr", "20gr", "1Con", "2 G√≥i"], keepNames: ["Nem", "Tobiko", "Ebiko", "Ph√¥ Mai Malaysia", "D·ªìi S·ª•n", "Rong"], garbageKeywords: ["X·ªëp", "Product-Haravan", "M√≥c Kho√°", "Ship", "S·∫£n Ph·∫©m Th√™m", "T√∫i H√∫t Ch√¢n Kh√¥ng", "Ph√≠ D·ªãch V·ª•", "T·∫£ng", "C∆∞·ªõc Xe", "ƒê·ªçc Ghi Ch√∫", "Ph√≠ DV"], sashimiKeywords: ["Sashimi", "Wasabi", "Rong"], meatKeywords: ["Heo", "B√≤", "G√†", "Ng·ªóng"], seafoodKeywords: ["T√¥m", "Cua", "Ghe", "Gh·∫π", "V·∫πm", "C·ªìi", "ƒêi·ªáp", "B√†o Ng∆∞", "Ngh√™u", "H√†u", "C√°", "M·ª±c", "S√≤", "L∆∞∆°n", "Rong", "H·∫£i", "B√†o"] };

    const container = document.getElementById('employee-container');
    EMPLOYEES.forEach(emp => {
        const div = document.createElement('div');
        div.className = 'user-item';
        div.innerHTML = `<input type="checkbox" class="emp-check" id="chk_${emp.id}" value="${emp.id}"><label for="chk_${emp.id}">${emp.label}</label>`;
        container.appendChild(div);
    });

    function getCurrentTimeStr() { const d = new Date(); return `${String(d.getHours()).padStart(2, '0')}:${String(d.getMinutes()).padStart(2, '0')} ng√†y ${String(d.getDate()).padStart(2, '0')}/${String(d.getMonth() + 1).padStart(2, '0')}/${d.getFullYear()}`; }
    function log(msg, type='info') { const c = document.getElementById('log-console'); let color='#eceff1'; if(type==='success') color='#69f0ae'; if(type==='error') color='#ff5252'; if(type==='warn') color='#ffd740'; c.innerHTML += `<div style="color:${color}">[${new Date().toLocaleTimeString()}] ${msg}</div>`; c.scrollTop = c.scrollHeight; }
    document.getElementById('upload').addEventListener('change', function(){ const n = this.files[0] ? this.files[0].name : "(Ch∆∞a ch·ªçn file)"; document.getElementById('file-name').innerText = n; if(this.files[0]) document.getElementById('file-name').style.color = "#0277bd"; });
    function toggleAll(source) { document.querySelectorAll('.emp-check').forEach(cb => cb.checked = source.checked); }
    function generateSmartLink(n) { const u = n.toUpperCase(); for(let k of SEARCH_KEYWORDS) if(u.includes(k.toUpperCase())) return `https://haisankyha.vn/search?type=product&q=${encodeURIComponent(k)}`; return `https://haisankyha.vn/search?type=product&q=${encodeURIComponent(n.split(" ").slice(0, 4).join(" "))}`; }
    function parse(v) { return parseFloat(String(v).replace(/[^0-9]/g,''))||0; }
    function fmt(v) { return (v<=0)?"Li√™n H·ªá":v.toLocaleString('en-US'); }

    function processData(jsonData) {
        const sRow = jsonData[0];
        const find = (keys) => Object.keys(sRow).find(k=>keys.some(x=>k.toLowerCase().includes(x.toLowerCase())));
        const cN=find(["T√™n h√†ng","T√™n s·∫£n ph·∫©m"]), cR=find(["B·∫£ng gi√° chung","Gi√° l·∫ª"]), cC=find(["Gi√° CTV"]), c10=find(["S·ªâ t·ª´ 10kg","Gi√° 10kg"]), c50=find(["S·ªâ tr√™n 50kg","Gi√° 50kg"]);
        
        let processed = [];
        jsonData.forEach(row => {
            let n = String(row[cN]||"").trim(), u = String(row["ƒê∆°n v·ªã t√≠nh"]||"").toLowerCase();
            if (!n) return;
            let isKeep = CONFIG.keepNames.some(x => n.toLowerCase().includes(x.toLowerCase()));
            if (!isKeep) { if (u.includes("500gr") || CONFIG.deleteKeywords.some(k => u.includes(k.toLowerCase()) || n.toLowerCase().includes(k.toLowerCase())) || CONFIG.garbageKeywords.some(k => JSON.stringify(row).toLowerCase().includes(k.toLowerCase()))) return; }
            let p10 = parse(row[c10]), p50 = parse(row[c50]);
            let v10 = n.match(/-\s*[08]$/) ? p10 : Math.ceil((p10/1.05)/1000)*1000;
            let v50 = n.match(/-\s*[08]$/) ? p50 : Math.ceil((p50/1.05)/1000)*1000;
            processed.push({ name: n, link: generateSmartLink(n), retail: fmt(parse(row[cR])), ctv: fmt(parse(row[cC])), vat10: fmt(v10), hkd10: fmt(p10), vat50: fmt(v50), hkd50: fmt(p50) });
        });
        
        let g = { sashimi: [], seafood: [], meat: [], other: [] };
        processed.forEach(i => {
            let n = i.name.toLowerCase();
            if (CONFIG.sashimiKeywords.some(k=>n.includes(k.toLowerCase()))) g.sashimi.push(i);
            else if (CONFIG.seafoodKeywords.some(k=>n.includes(k.toLowerCase()))) g.seafood.push(i);
            else if (CONFIG.meatKeywords.some(k=>n.includes(k.toLowerCase()))) g.meat.push(i);
            else g.other.push(i);
        });
        for(let k in g) g[k].sort((a,b)=>a.name.localeCompare(b.name));
        return g;
    }

    function generateHTMLFinal(g, emp, mode, dateStr, extraConfig) {
        const hc = (mode === 'retail') ? '#e65100' : '#0056b3';
        const ts = (mode === 'retail') ? "width:100%; border-collapse:collapse;" : "width:100%; border-collapse:collapse; min-width:800px;";
        const ths = `background:${hc}; color:white; padding:8px; border:1px solid #ccc; text-align:center; white-space:nowrap;`;
        const tds = "padding:8px; border:1px solid #ccc; text-align:center; color:#333; vertical-align: middle;";
        let nts = (mode === 'retail') ? "padding:8px; border:1px solid #ccc; text-align:left; font-weight:bold; vertical-align: middle;" 
            : "padding:8px; border:1px solid #ccc; text-align:left; font-weight:bold; min-width:150px; position:sticky; left:0; background:white; z-index:10; border-right:2px solid #ddd; vertical-align: middle;";
        
        let note = extraConfig.noteContent ? `<span style="color:#d32f2f; margin-left:10px; font-weight:bold;">üì¢ ${extraConfig.noteContent}</span>` : "";
        let sticky = extraConfig.hideSticky ? "" : "position:sticky; top:0; z-index:1000; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);";
        
        const header = `<div style="${sticky} background:white; border-bottom:1px solid #eee;">
            <div style="font-size:13px; color:#455a64; font-weight:500; text-align:center; padding:8px; background:#fff8e1; border-bottom:1px dashed #eee;">üïí C·∫≠p nh·∫≠t: <span style="color:#0277bd; font-weight:bold;">${dateStr}</span>${note}</div>
            <div style="padding:10px; background:white; overflow-x:auto; white-space:nowrap; -webkit-overflow-scrolling:touch; display:flex; gap:5px;">
                <a href="#sashimi" style="display:inline-block; padding:5px 12px; background:#f1f3f4; border-radius:15px; color:#333; text-decoration:none; font-size:12px; font-weight:bold; border:1px solid #ddd;">üç£ Sashimi</a>
                <a href="#haisan" style="display:inline-block; padding:5px 12px; background:#f1f3f4; border-radius:15px; color:#333; text-decoration:none; font-size:12px; font-weight:bold; border:1px solid #ddd;">ü¶Ä H·∫£i S·∫£n</a>
                <a href="#thit" style="display:inline-block; padding:5px 12px; background:#f1f3f4; border-radius:15px; color:#333; text-decoration:none; font-size:12px; font-weight:bold; border:1px solid #ddd;">ü•© Th·ªãt</a>
                <a href="#khac" style="display:inline-block; padding:5px 12px; background:#f1f3f4; border-radius:15px; color:#333; text-decoration:none; font-size:12px; font-weight:bold; border:1px solid #ddd;">ü•¨ Kh√°c</a>
            </div>
        </div>`;

        const search = `<div style="padding:10px; background:white;"><input type="text" id="searchInput" placeholder="üîç T√¨m nhanh (VD: bao ngu)..." style="width:100%; padding:10px; border:2px solid ${hc}; border-radius:6px; outline:none; box-sizing:border-box; font-size:14px;"></div>
        <script>document.getElementById('searchInput').addEventListener('keyup', function(){ let v = this.value.toLowerCase().normalize("NFD").replace(/[\\u0300-\\u036f]/g, ""); document.querySelectorAll('tbody tr').forEach(r => { let t = r.textContent.toLowerCase().normalize("NFD").replace(/[\\u0300-\\u036f]/g, ""); r.style.display = t.includes(v) ? '' : 'none'; }); });<\/script>`;

        let footer = "";
        if (emp.type === "general") {
            const items = FOOTER_CONTACTS.map(c => `<a href="https://zalo.me/${c.phone}" target="_blank" style="flex:1; display:flex; flex-direction:column; align-items:center; justify-content:center; text-decoration:none; color:#333; border-right:1px solid #eee;"><span style="font-size:9px; font-weight:bold; color:${hc};">${c.name}</span></a>`).join('');
            footer = `<div style="position:fixed; bottom:0; left:0; width:100%; height:40px; background:white; border-top:1px solid #ccc; z-index:9999; display:flex; box-shadow:0 -2px 10px rgba(0,0,0,0.1);">${items}</div>`;
        } else {
            const z = ZALO_INFO[emp.id];
            footer = `<a href="https://zalo.me/${z.phone}" target="_blank" style="position:fixed; bottom:20px; right:20px; z-index:9999; display:flex; align-items:center; background:${hc}; color:white; padding:8px 15px; border-radius:30px; text-decoration:none; box-shadow:0 4px 10px rgba(0,0,0,0.3); font-weight:bold; border:2px solid white;">Chat Zalo: ${z.zLabel}</a>`;
        }

        let h = (mode==='retail') ? `<thead><tr><th style="${ths}">T√™n</th><th style="${ths}">Gi√° L·∫ª</th></tr></thead>` : `<thead><tr><th style="${ths}">T√™n</th><th style="${ths}">VAT 10</th><th style="${ths}">HKD 10</th><th style="${ths}">VAT 50</th><th style="${ths}">HKD 50</th><th style="${ths}">CTV</th><th style="${ths}">L·∫ª</th></tr></thead>`;
        const r = (l) => l.map(i => {
            const link = i.link ? `<div style="margin-top:2px;"><a href="${i.link}" target="_blank" style="color:#e65100; font-size:11px; font-style:italic; text-decoration:none;">üëâ Xem Web</a></div>` : "";
            if(mode==='retail') return `<tr><td style="${nts}">${i.name}${link}</td><td style="${tds} font-weight:bold; color:#d32f2f;">${i.retail}</td></tr>`;
            return `<tr><td style="${nts}">${i.name}${link}</td><td style="${tds}">${i.vat10}</td><td style="${tds}">${i.hkd10}</td><td style="${tds}">${i.vat50}</td><td style="${tds}">${i.hkd50}</td><td style="${tds}">${i.ctv}</td><td style="${tds}">${i.retail}</td></tr>`;
        }).join('');
        const sec = (t, d, id) => d.length ? `<div id="${id}" style="background:#f4f6f8; color:${hc}; padding:10px; font-weight:bold; margin:20px 0 5px 0; border-left:4px solid ${hc}; scroll-margin-top:140px;">${t}</div><div style="width:100%; overflow-x:auto;"><table style="${ts}">${h}<tbody>${r(d)}</tbody></table></div>` : '';
        
        return `<div id="pricing-tool-wrapper" style="font-family:Arial, sans-serif; padding-bottom:60px;">${header}${search}${sec('SASHIMI & SUSHI', g.sashimi, 'sashimi')}${sec('H·∫¢I S·∫¢N', g.seafood, 'haisan')}${sec('TH·ªäT', g.meat, 'thit')}${sec('KH√ÅC', g.other, 'khac')}${footer}</div>`;
    }

    async function processDownload(mode) { handleProcess('download', mode); }
    async function processSync(mode) {
        if(document.querySelectorAll('.emp-check:checked').length === 0) return alert('‚ö†Ô∏è Vui l√≤ng ch·ªçn √≠t nh·∫•t 1 ng∆∞·ªùi!');
        if(confirm(`‚ö†Ô∏è B·∫†N S·∫ÆP C·∫¨P NH·∫¨T CHO ${document.querySelectorAll('.emp-check:checked').length} NG∆Ø·ªúI?\nD·ªØ li·ªáu tr√™n Web s·∫Ω b·ªã ghi ƒë√®.`)) handleProcess('sync', mode);
    }
    const delay = ms => new Promise(res => setTimeout(res, ms));

    async function handleProcess(actionType, mode) {
        const fileInput = document.getElementById('upload');
        const selectedChecks = Array.from(document.querySelectorAll('.emp-check:checked'));
        const progressBar = document.getElementById('progress-bar');
        const extraConfig = { noteContent: document.getElementById('update_note').value.trim(), hideSticky: document.getElementById('hide_sticky_menu').checked };

        if (!fileInput.files.length) return alert('‚ö†Ô∏è Vui l√≤ng ch·ªçn file Excel!');
        let btnId = (actionType === 'sync') ? (mode === 'wholesale' ? 'btn-sync-si' : 'btn-sync-le') : null;
        if(btnId) { var btn = document.getElementById(btnId); var originalText = btn.innerHTML; btn.innerHTML = "‚è≥ RUNNING..."; btn.disabled = true; }

        log("=== B·∫ÆT ƒê·∫¶U X·ª¨ L√ù ===");
        progressBar.style.width = '0%';

        const reader = new FileReader();
        reader.onload = async function(e) {
            try {
                const workbook = XLSX.read(e.target.result, {type: 'array'});
                const jsonData = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]], {defval: ""});
                const processedGroups = processData(jsonData);
                const staticDateStr = getCurrentTimeStr();

                if (actionType === 'download') {
                    // PH·∫¶N T·∫¢I FILE: Gi·ªØ nguy√™n HTML cho ph√©p xem offline
                    const fullHtml = `<!DOCTYPE html><html><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>B·∫£ng Gi√°</title></head><body>${generateHTMLFinal(processedGroups, HARAVAN_IDS[selectedChecks[0].value], mode, staticDateStr, extraConfig)}</body></html>`;
                    
                    if(selectedChecks.length === 1) {
                         const empId = selectedChecks[0].value;
                         const emp = EMPLOYEES.find(e => e.id === empId);
                         saveAs(new Blob([fullHtml], {type: "text/html;charset=utf-8"}), `BangGia_${mode === 'wholesale' ? 'SI' : 'LE'}_${emp.label}.html`);
                         log("ƒê√£ t·∫£i file th√†nh c√¥ng!", 'success');
                    } else {
                         const zip = new JSZip();
                         selectedChecks.forEach(chk => {
                             const empId = chk.value;
                             const emp = EMPLOYEES.find(e => e.id === empId);
                             const content = generateHTMLFinal(processedGroups, emp, mode, staticDateStr, extraConfig);
                             zip.file(`BangGia_${mode === 'wholesale' ? 'SI' : 'LE'}_${emp.label}.html`, `<!DOCTYPE html><html><head><meta charset="UTF-8"><title>BG</title></head><body>${content}</body></html>`);
                         });
                         saveAs(await zip.generateAsync({type:"blob"}), `BangGia_${mode === 'wholesale' ? 'SI' : 'LE'}_All.zip`);
                         log("ƒê√£ t·∫£i file ZIP th√†nh c√¥ng!", 'success');
                    }
                } else {
                    const token = document.getElementById('haravan_token').value.trim();
                    if (!token) throw new Error("Vui l√≤ng nh·∫≠p Token API!");
                    
                    // K·∫æT N·ªêI VERCEL PROXY
                    const isNetlify = window.location.hostname.includes('netlify.app') || window.location.hostname.includes('vercel.app');
                    const apiPrefix = isNetlify ? '/haravan-api' : 'https://apis.haravan.com';

                    let successCount = 0;
                    
                    for(const [index, chk] of selectedChecks.entries()) {
                        const empId = chk.value;
                        const emp = EMPLOYEES.find(e => e.id === empId);
                        const pageId = HARAVAN_IDS[empId][mode];
                        const htmlContent = generateHTMLFinal(processedGroups, emp, mode, staticDateStr, extraConfig);
                        
                        const percent = Math.round(((index + 1) / selectedChecks.length) * 100);
                        progressBar.style.width = `${percent}%`;
                        log(`ƒêang x·ª≠ l√Ω: ${emp.label}...`);

                        if(index > 0) await delay(1000);

                        try {
                            // 1. GET (L·∫•y Title c≈©)
                            const getRes = await fetch(`${apiPrefix}/web/pages/${pageId}.json`, {
                                method: 'GET',
                                headers: { 
                                    'Content-Type': 'application/json',
                                    'Authorization': `Bearer ${token}`, 
                                    'Accept': 'application/json'
                                }
                            });
                            
                            let currentTitle = `B·∫£ng gi√° ${pageId}`;
                            if(getRes.ok) {
                                const pageData = await getRes.json();
                                if(pageData.page && pageData.page.title) currentTitle = pageData.page.title;
                            }

                            // 2. PUT (C·∫≠p nh·∫≠t)
                            const response = await fetch(`${apiPrefix}/web/pages/${pageId}.json`, {
                                method: 'PUT',
                                headers: { 
                                    'Content-Type': 'application/json',
                                    'Authorization': `Bearer ${token}`,
                                    'Accept': 'application/json'
                                },
                                body: JSON.stringify({ page: { id: pageId, title: currentTitle, body_html: htmlContent } })
                            });

                            if (!response.ok) { const errText = await response.text(); throw new Error(`${response.status} - ${errText.slice(0, 100)}`); }
                            successCount++;
                            log(`‚úÖ ${emp.label}: Th√†nh c√¥ng!`, 'success');
                        } catch (err) {
                            log(`‚ùå ${emp.label}: L·ªói (${err.message})`, 'error');
                        }
                    }
                    if(successCount > 0) { log("=== HO√ÄN T·∫§T TO√ÄN B·ªò ===", 'success'); alert("C·∫≠p nh·∫≠t th√†nh c√¥ng!"); }
                }
            } catch (err) {
                alert("L·ªói: " + err.message);
                log("L·ªói: " + err.message, 'error');
            } finally {
                if(btnId) { var btn = document.getElementById(btnId); btn.innerHTML = originalText; btn.disabled = false; }
            }
        };
        reader.readAsArrayBuffer(fileInput.files[0]);
    }
</script>
</body>
</html>
